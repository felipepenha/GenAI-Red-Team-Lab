.PHONY: help build up down clean logs n8n

# Default target
help:
	@echo "n8n Sandbox (CVE-2026-21877) - Available Commands:"
	@echo ""
	@echo "  make n8n           - Full setup: clean, build, and start n8n"
	@echo "  make build         - Build the container image"
	@echo "  make up            - Run the container"
	@echo "  make down          - Stop and remove the container"
	@echo "  make logs          - View container logs"
	@echo "  make clean         - Clean up containers and images"
	@echo ""
	@echo "Environment:"
	@echo "  - n8n version: 1.120.0"
	@echo "  - URL: http://localhost:5678"
	@echo "  - Vulnerability: CVE-2026-21877 (RCE via Arbitrary File Write)"
	@echo ""

build:
	@echo "ðŸ”¨ Building container image..."
	podman build -f Containerfile -t n8n_vuln_build .
	# Create a network for the containers if needed (reusing the one from llm_local or creating new)
	@echo "ðŸŒ Creating network..."
	-podman network create --driver bridge sec_test_net 2>/dev/null || true

up:
	@echo "ðŸš€ Starting container..."
	# N8N_HOST=0.0.0.0 and defaults to ensure it's accessible.
	# NODES_EXCLUDE="" to ensure all nodes (including vulnerable/dangerous ones) are active.
	podman run -d --name n8n_vuln_container \
		-p 5678:5678 \
		--network sec_test_net \
		-v ./data:/home/node/.n8n \
		-e N8N_HOST=0.0.0.0 \
		-e N8N_PORT=5678 \
		-e WEBHOOK_URL=http://localhost:5678/ \
		-e NODES_EXCLUDE="" \
		n8n_vuln_build
	@echo "âœ… Container started at http://localhost:5678"

down:
	@echo "ðŸ›‘ Stopping container..."
	podman rm -f n8n_vuln_container
	@echo "âœ… Container stopped!"

clean:
	@echo "ðŸ§¹ Cleaning up containers and images..."
	-podman rm -f n8n_vuln_container 2>/dev/null || true
	-podman rmi n8n_vuln_build 2>/dev/null || true
	-podman network rm sec_test_net 2>/dev/null || true
	@echo "âœ… Cleanup complete!"

logs:
	podman logs -f n8n_vuln_container

n8n: clean build up
	@echo "âœ… n8n is running. Access it at http://localhost:5678"
