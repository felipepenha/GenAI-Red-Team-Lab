.PHONY: help setup attack stop all format

# Variables
SANDBOX_DIR := ../../sandboxes/agentic_local_n8n_v1.65.0
# We reuse the same sandbox as it is the standard n8n environment for this repo
# even if we are demonstrating a newer CVE.

# Default target
help:
	@echo "n8n Exploitation (CVE-2026-21858) - Ni8mare - Available Commands:"
	@echo ""
	@echo "  make setup    - Build and start the vulnerable n8n sandbox (seeded)"
	@echo "  make attack   - Run the arbitrary file read exploitation script"
	@echo "  make stop     - Stop and remove the sandbox container"
	@echo "  make all      - Run setup, attack, and stop in sequence"
	@echo "  make format   - Run code formatting (black)"
	@echo ""
	@echo "Environment:"
	@echo "  - Sandbox Directory: $(SANDBOX_DIR)"
	@echo "  - Target: http://localhost:5678"
	@echo ""

setup:
	@echo "üöÄ Setting up Vulnerable n8n environment..."
	$(MAKE) -C $(SANDBOX_DIR) n8n
	@echo "üõ†Ô∏è Pre-configuring vulnerable webhook..."
	uv run setup_target.py

attack:
	@echo "‚öîÔ∏è  Launching UNAUTHENTICATED CVE-2026-21858 (Ni8mare) exploit..."
	uv run attack.py

sync:
	uv sync

lock:
	uv lock

format:
	uv run black .
	uv run isort .
	uv run mypy .

stop:
	@echo "üßπ Tearing down ..."
	$(MAKE) -C $(SANDBOX_DIR) down
	@echo "‚úÖ Environment cleaned up!"

all: stop setup attack stop
	@echo "Exploitation Demo - Completed!"
