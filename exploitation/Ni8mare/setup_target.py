#!/usr/bin/env python3
import sys
import time

import requests
import toml


def load_config():
    try:
        with open("config.toml", "r") as f:
            return toml.load(f)["attack"]
    except Exception as e:
        print(f"[-] Error loading config.toml: {e}")
        sys.exit(1)


def login(session, base_url, email, password):
    print("[*] Authenticating to setup vulnerable workflow...")
    login_url = f"{base_url}/rest/login"
    payload = {"email": email, "password": password}

    for i in range(30):
        try:
            res = session.post(login_url, json=payload)
            if res.status_code == 200:
                print("[+] Login successful.")
                return True
            elif res.status_code in [401, 403, 500]:
                register_url = f"{base_url}/rest/owner/setup"
                reg_payload = {
                    "email": email,
                    "password": password,
                    "firstName": "Red",
                    "lastName": "Team",
                }
                reg_res = session.post(register_url, json=reg_payload)
                if reg_res.status_code == 200:
                    print("[+] Registration successful (Fallback). Retrying login...")
                    time.sleep(2)
                    continue
            time.sleep(2)
        except requests.exceptions.ConnectionError:
            time.sleep(2)
    return False


def create_workflow(session, base_url):
    print("[*] Creating vulnerable workflow (Webhook -> Respond to Webhook)...")

    # Ensure we have the latest cookies
    cookies = session.cookies.get_dict()
    print(f"[*] Debug: Session cookies: {cookies.keys()}")

    payload = {
        "name": "Ni8mare Target",
        "active": True,
        "settings": {
            "saveDataErrorExecution": "none",
            "saveDataSuccessExecution": "none",
            "saveExecutionProgress": False,
            "saveManualExecutions": False,
            "saveBinaryInExecution": False,
        },
        "nodes": [
            {
                "parameters": {
                    "httpMethod": "POST",
                    "path": "ni8mare",
                    "responseMode": "responseNode",
                    "options": {},
                },
                "name": "Webhook",
                "type": "n8n-nodes-base.webhook",
                "typeVersion": 1,
                "position": [250, 300],
                "webhookId": "ni8mare-exploit",
            },
            {
                "parameters": {
                    "respondWith": "binary",
                    "binaryPropertyName": "exploit_db",
                    "options": {},
                },
                "name": "Respond to Webhook",
                "type": "n8n-nodes-base.respondToWebhook",
                "typeVersion": 1,
                "position": [450, 300],
            },
        ],
        "connections": {
            "Webhook": {
                "main": [[{"node": "Respond to Webhook", "type": "main", "index": 0}]]
            }
        },
    }
    try:
        res = session.post(f"{base_url}/rest/workflows", json=payload, cookies=cookies)
        if res.status_code == 200:
            wf_id = res.json()["data"]["id"]
            session.patch(
                f"{base_url}/rest/workflows/{wf_id}",
                json={"active": True},
                cookies=cookies,
            )
            print(f"[+] Workflow {wf_id} created and activated.")
            return True
        else:
            print(f"[-] Failed to create workflow: {res.status_code} - {res.text}")
            return False
    except Exception as e:
        print(f"[-] Exception creating workflow: {e}")
        return False


def main():
    config = load_config()
    s = requests.Session()
    if login(s, config["target_url"], config["email"], config["password"]):
        if create_workflow(s, config["target_url"]):
            print("[+] Environment setup complete.")
            sys.exit(0)
    sys.exit(1)


if __name__ == "__main__":
    main()
