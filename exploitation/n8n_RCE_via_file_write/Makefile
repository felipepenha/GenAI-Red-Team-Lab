SANDBOX_DIR := ../../sandboxes/agentic_local_n8n_v1.120.0

.PHONY: help setup attack stop all sync lock format

# Default target
help:
	@echo "n8n Exploitation (CVE-2026-21877) - Available Commands:"
	@echo ""
	@echo "  make setup    - Build and start the vulnerable n8n sandbox"
	@echo "  make attack   - Run the generic RCE exploitation script"
	@echo "  make stop     - Stop and remove the sandbox container"
	@echo "  make all      - Run setup, attack, and stop in sequence"
	@echo "  make format   - Run code formatting (black, isort, mypy)"
	@echo "  make sync     - Sync dependencies with uv"
	@echo "  make lock     - Lock dependencies with uv"
	@echo ""
	@echo "Environment:"
	@echo "  - Sandbox Directory: $(SANDBOX_DIR)"
	@echo "  - Target: http://localhost:5678"
	@echo ""

sync:
	uv sync

lock:
	uv lock

format:
	uv run black .
	uv run isort .
	uv run mypy .

setup:
	@echo "üöÄ Setting up Vulnerable n8n environment..."
	$(MAKE) -C $(SANDBOX_DIR) n8n
	@echo "‚è≥ Waiting for service to be fully ready..."
	@sleep 10
	@echo "‚úÖ Environment ready!"

attack: sync lock
	@echo "‚öîÔ∏è  Launching CVE-2026-21877 exploit..."
	uv run attack.py

stop:
	@echo "üßπ Tearing down ..."
	$(MAKE) -C $(SANDBOX_DIR) down
	@echo "‚úÖ Environment cleaned up!"

all: stop setup attack stop
	@echo "Exploitation Demo - Completed!"
