import sys
import tomllib

from gradio_client import Client  # type: ignore


def attack():
    # Load prompt from configuration
    try:
        with open("config/config.toml", "rb") as f:
            config = tomllib.load(f)
        prompts = config["attack"]["prompt"]
        if isinstance(prompts, str):
            prompts = [prompts]
    except FileNotFoundError:
        print("[!] config/config.toml not found.")
        sys.exit(1)
    except Exception as e:
        print(f"[!] Error loading config: {e}")
        sys.exit(1)

    try:
        print(f"[*] Connecting to Gradio interface at http://localhost:7860...")
        client = Client("http://localhost:7860")

        # Sync log cursor before starting
        _, processed_lines = get_server_logs(skip_lines=0, print_output=False)

        for i, prompt in enumerate(prompts, 1):
            print(f"\n[*] --- Attack {i}/{len(prompts)} ---")
            print(f"[*] Sending adversarial prompt: {prompt}")
            result = client.predict(
                message=prompt,
                api_name="/chat",
            )
            print(f"[*] Response received:\n{result}")

            if "--- SERVER SIDE LEAKS ---" in result:
                # Leaks present in response. Update cursor but don't print again.
                import time

                time.sleep(2)  # Allow logs to flush
                _, processed_lines = get_server_logs(
                    skip_lines=processed_lines, print_output=False
                )
            else:
                # Check logs for this specific attack
                import time

                time.sleep(2)  # Allow logs to flush
                print("\n--- SERVER SIDE LEAKS ---")
                found_leaks, processed_lines = get_server_logs(
                    skip_lines=processed_lines, print_output=True
                )
                if not found_leaks:
                    print("[-] No server-side leaks detected. Attack failed.")

    except Exception as e:
        print(f"[!] Error communicating with API: {e}")
        sys.exit(1)


def get_server_logs(skip_lines=0, print_output=True):
    import shutil
    import subprocess

    container_runtime = "podman" if shutil.which("podman") else "docker"
    try:
        # Fetch logs from the gradio_container
        result = subprocess.run(
            [container_runtime, "logs", "gradio_container"],
            capture_output=True,
            text=True,
            check=False,
        )

        if result.returncode != 0:
            print(f"[!] Could not fetch logs: {result.stderr.strip()}")
            return False, 0

        logs = result.stdout + result.stderr
        all_lines = logs.splitlines()
        total_lines = len(all_lines)

        found_leaks = False
        for line in all_lines[skip_lines:]:
            if (
                "DESERIALIZED OBJECT:" in line
                or "RCE RESULT:" in line
                or "LEAKED SECRET:" in line
            ):
                if print_output:
                    print(line.strip())
                found_leaks = True

        return found_leaks, total_lines

    except Exception as e:
        print(f"[!] Error processing logs: {e}")
        return False, 0


if __name__ == "__main__":
    attack()
